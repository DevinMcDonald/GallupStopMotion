services:
  backend:
    build: ./backend
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    ports: ["8000:8000"]
    volumes:
      - ./backend:/app:delegated
    environment:
      ENV: dev
      FRAMES_DIR: /data/session_frames
    init: true
    stop_grace_period: 20s
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  frontend:
    build: ./frontend
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]
    ports: ["5173:5173"]
    volumes:
      - ./frontend:/app:delegated
      - /app/node_modules
    environment:
      NODE_ENV: development
    init: true
    stop_grace_period: 10s
    restart: "no"

  # ---------- macOS variants (Docker Desktop) ----------
  # Map host device to a stable in-container name /dev/arduino
  buttons-mac:
    build: ./backend                     # reuse backend image
    command: ["/usr/local/bin/monitor-entrypoint.sh"]
    depends_on:
      backend:
        condition: service_healthy

    # Serial-over-TCP bridge (created via: make mac)
    environment:
      SERIAL_PORT: "socket://host.docker.internal:7000"
      SERIAL_BAUD: "115200"
      BACKEND_URL: "http://backend:8000"

    # IMPORTANT: No `devices:` on macOS
    volumes:
      - ./backend:/app:delegated         # hot-reload python on host

    init: true
    restart: "no"
    profiles: ["mac-mcu"]

  mcu-mac:
    build: ./microcontroller
    environment:
      FQBN: arduino:avr:uno
      PORT: "/dev/arduino"
      SKIP_LIBS: "0"
      SKIP_CORE: "0"
      SKETCH: /workspace/Sketch/Sketch.ino
    devices:
      - /dev/tty.usbmodem1201:/dev/arduino
    volumes:
      - ./microcontroller:/workspace:delegated
    init: true
    restart: "no"
    profiles: ["mac-mcu"]

  # ---------- Linux variants (VM/target boxes) ----------
  buttons-linux:
    build: ./backend
    command: ["/usr/local/bin/monitor-entrypoint.sh"]
    depends_on:
      backend:
        condition: service_healthy
    environment:
      SERIAL_BAUD: "115200"
      BACKEND_URL: "http://backend:8000"
      SERIAL_PORT: ""   # auto-detect /dev/ttyACM* or /dev/ttyUSB* in entrypoint
    devices:
      - /dev/ttyACM0:/dev/ttyACM0
      - /dev/ttyUSB0:/dev/ttyUSB0
    volumes:
      - ./backend:/app:delegated
    init: true
    restart: "no"
    profiles: ["linux-mcu"]

  mcu-linux:
    build: ./microcontroller
    environment:
      FQBN: arduino:avr:uno
      PORT: ""         # uploader script can auto-detect or set explicitly
      SKIP_LIBS: "0"
      SKIP_CORE: "0"
      SKETCH: /workspace/Sketch/Sketch.ino
    devices:
      - /dev/ttyACM0:/dev/ttyACM0
      - /dev/ttyUSB0:/dev/ttyUSB0
    volumes:
      - ./microcontroller:/workspace:delegated
    init: true
    restart: "no"
    profiles: ["linux-mcu"]
